# Tomghost Walkthrough (2023)
## Detailed walkthough for TryHackMe's tomghost CTF
![tomghost banner](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/tomghost_banner.png)

[Tomghost's CTF room](https://tryhackme.com/room/tomghost)'s goal is to "_identify recent vulnerabilities to try exploit the system or read files that you should not have access to_". Let's first start with gaining an understanding what we are actually trying to do on this room.

# Background Information
As a beginner, I was using the terms **Apache** and **Apache Tomcat** interchangeably, but they are not really the same thing. According to this short [GeeksForGeeks article](https://www.geeksforgeeks.org/difference-between-apache-tomcat-server-and-apache-web-server/):  
**Apache web server** is designed to create the web-servers and it can host one or more HTTP based web-servers, while **Apache Tomcat** is a web container that allows the users to run Servlet and JAVA Server Pages that are based on the web-applications and it can also be used as the HTTP server. 

This room is focused on a vulnerability found in the **Apache Tomcat** container, called _Ghostcast_.
![ghostscat banner](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/ghostcat_banner.png)

The **Ghostcat vulnerability** does essentially what the room's description says: if the **Apache Jserv Protocol (AJP)** is exposed over the internet (usually on port 8009), it allows an attacker to **read sensitive files from the Tomcat directories**.

Based on the above information, we kind of know what we should expect:
1. Find the **AJP protocol** exposed on port 8009.
2. Find an **existing exploit** to leverage, gain non-privileged access and snath our first 🚩.
3. Find a way to **escalate our privileges** to root and snatch our second 🚩.

# CTF Process
1. Let's start enumerating our target with a port-scanning using nmap:
```bash
nmap <target-ip> -sV -T4 -oA nmap-scan -open
```
`<target-ip>` The target machine's IP.  
`-sV` Attempts to determine the version of the service running on port.  
`-T4` Aggressive (4) speeds scans; assumes you are on a reasonably fast and reliable network.  
`-oA <file-name>` Output in the three major formats at once.  
`-open` Show only open (or possibly open) ports.  

As expected, the results include port 8009 using the AJP protocol:
![Port-scanning results](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/nmap-scan.png)

2. Searching [**Exploit-db**](www.exploit-db.com) for an existing vulnerability related to "_apache tomcat ajp_", we find [**CVE-2020–1938**](https://www.exploit-db.com/exploits/49039), which conveniently let us know that it's included in **Metasploit**:
![CVE-2020–19383](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/exploit-db.png)

3. Launching **Metasploit** (using the  `msfconsole` command) and searching for **CVE-2020–1938**, confirms that there is an existing module which we can directly use as follows:
![The CVE-2020–1938 exploit on Metasploit](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/msf_exploit1.png)

As we can see using by using the `options command`, everything but `RHOSTS` is already good to go. We can pass our target's IP to `RHOSTS` by typing `set RHOSTS <target-ip>`. We can then use the `check` command to find out if our target is vulnerable, and then just run the exploit:
![Running the exploit](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/msf_exploit2.png)

By exploiting the Ghostcast vulnerability we are expecting to find and read sensitive files in the Tomcat directories. The exploit managed to do that for us successfully, providing us with a pair of credentials to use 👏.

4. Remember that the nmap results (step 1), included an **SSH server**, which we can use by try connecting using the obtained credentials:
![Connecting to the SSH server](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/ssh.png)

Success 🎉! We have now gained an **initial foothold** with a low-privileged user, as planned, and we should be able to find and (maybe) read our first 🚩. 
We know that we are searching for a file called `user.txt`, so let's just search for that:
![Capturing our first flag!](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/first_flag.jpg)

The find command works as follows:  
`/` Start searching from the root directory.  
`-iname user.txt` Search, ignoring casing, for a file called user.txt.  
`-type f` Search only for files.  
`2>/dev/null` Suppress any errors.  

5. The only thing left is to find the `root.txt` file which, as the name suggests, would require **escalating our privileges** to a root account.

When listing the files in our current user's home directory, two files appear: `credential.pgp` and `tryhackme.asc`:
![Files found in the current user's home directory](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/ssh_files.png)

[**GPG**](https://www.redhat.com/sysadmin/encryption-decryption-gpg) is a popular Linux security tool for encrypting files. All we need to know is the following:
1. `credential.pgp` is a binary GPG encryted file which, based on its name, contains the root credentials we are searching for.  
2. `tryhackme.asc` contains a hashed password which might be needed for decrypting the above file.

We can transfer these files to our local machine using the `scp` command and try to first decrypt the file:
![Transferring the files locally and attemp to decrypt the GPG file](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/scp%2Bdecrypt.png)

As we can see, the GPG file is encrypted with a **secret key**. If we are trying to import `tryhackme.asc` as a key to GPG, we are asked to provide a **passphrase**:
![GPG failed key import](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/gpg_failed_import.png)

So, let's use **John The Ripper** for cracking that hash, and then provide it as passphrase when asked.

We first need to convert the hash file into a suitable format for john using `gpg2john`, and then pass that file to john:
![Cracking hashes with John](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/john_hash.png)

Now, we can use this passphrase when importing `tryhackme.asc` as a key to GPG, as well as when we are asked for it again, while decrypting `credentials.gpg`:
![ImportING a key and decrypting a GPG-encrypted file](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/gpg_decryption.png)

6. We have now obtained the credentials of another low-privileged user, what is called **horizontal privilege escalation**.

Let's switch to that user and find out if there is anything that we can leverage that will allows us to gain a privileged account, that is, perform **vertical privilege escalation**.

By checking if there is any program that the user `merlin` could run as sudo, by typing `sudo -l`, we find out that the `zip` program is on that list:
![Checking for programs that our current user can use with sudo](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/suid_zip.png)

Visiting [GTFOBins](https://gtfobins.github.io/) and searching for `zip` we can find some interesting information:
![GTFOBins page for zip](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/gtfobins_zip.png)

By just following the instructions, we can get ourselves a root shell and capture our final 🚩🥂:
![Capturing our final flag 🥂!](https://github.com/CSpanias/pentesting.io/blob/main/thm/tomghost/media/final_flag.jpg)
